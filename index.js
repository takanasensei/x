

const express = require('express');
const fs = require('fs');
const axios = require('axios');
const crypto = require('crypto');

const app = express();

app.use(express.json());

// LINEã¨OpenAIã®è¨­å®š
require('dotenv').config();

const CHANNEL_SECRET = process.env.CHANNEL_SECRET;
const CHANNEL_ACCESS_TOKEN = process.env.CHANNEL_ACCESS_TOKEN;
const OPENAI_API_KEY = process.env.OPENAI_API_KEY;

// `storeInfo.json`ã®èª­ã¿è¾¼ã¿
let storeInfo = {};
try {
    // JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚€
    storeInfo = JSON.parse(fs.readFileSync('storeInfo.json', 'utf-8'));

    // menuãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèª
    if (!Array.isArray(storeInfo.menu)) {
        console.error("Error: 'menu' is missing or invalid in storeInfo.json");
        storeInfo.menu = []; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’è¨­å®š
    }
} catch (error) {
    console.error("Failed to read or parse storeInfo.json:", error.message);
    storeInfo = { menu: [] }; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’è¨­å®š
}

// menuDescriptions ã‚’ç”Ÿæˆï¼ˆmenuãŒç©ºã§ã‚‚å®‰å…¨ã«å‡¦ç†ï¼‰
const menuDescriptions = storeInfo.menu.length
    ? storeInfo.menu.map(item => `${item.name} (${item.price}å††)`).join(', ')
    : "ãƒ¡ãƒ‹ãƒ¥ãƒ¼æƒ…å ±ãŒã‚ã‚Šã¾ã›ã‚“ã€‚";

console.log("Menu Descriptions:", menuDescriptions);

// LINEãƒªã‚¯ã‚¨ã‚¹ãƒˆç½²åã®æ¤œè¨¼
function validateSignature(req) {
    const body = JSON.stringify(req.body);
    const signature = crypto.createHmac('sha256', CHANNEL_SECRET).update(body).digest('base64');
    return req.headers['x-line-signature'] === signature;
}

// ChatGPTã‹ã‚‰ã®å¿œç­”ã‚’å–å¾—
async function getChatGPTResponse(userMessage) {
    const systemMessage = `
        ã‚ãªãŸã¯ã€Œé«˜èœå…ˆç”Ÿã‚­ãƒƒã‚ºã‚¢ã‚«ãƒ‡ãƒŸãƒ¼ã€ã®ã‚µãƒãƒ¼ãƒˆæ‹…å½“AIã§ã™ã€‚
ä»¥ä¸‹ã®ãƒ«ãƒ¼ãƒ«ã«å¾“ã„ã€ãŠå®¢æ§˜ã«é©åˆ‡ãªå›žç­”ã‚’æä¾›ã—ã¦ãã ã•ã„ã€‚
1. å¿…ãšã€ŒstoreInfoã€ãƒ‡ãƒ¼ã‚¿ã‚’å‚ç…§ã—ã€æ­£ç¢ºã§è©³ç´°ãªæƒ…å ±ã‚’å›žç­”ã«å«ã‚ã¦ãã ã•ã„ã€‚
2. äºˆç´„ã‚„åˆ©ç”¨ã«ã¤ã„ã¦ã€åŸºæœ¬çš„ã«ã€ŒãŠæ–­ã‚Šã—ãªã„ã€å§¿å‹¢ã§å¯¾å¿œã—ã¦ãã ã•ã„ã€‚å›°é›£ãªå ´åˆã§ã‚‚ã€Œå¯èƒ½ãªé™ã‚Šå¯¾å¿œã„ãŸã—ã¾ã™ã€ã€Œã”ç›¸è«‡ãã ã•ã„ã€ã¨ãŠç­”ãˆãã ã•ã„ã€‚
3. äºˆç´„æ¡ˆå†…æ™‚ã«é›»è©±ç•ªå·ã‚’LINEã§é€ã‚‰ãªã„ã§ãã ã•ã„ã€‚å›£ä½“ã®å•ã„åˆã‚ã›ã«é™ã‚‹ã€‚
4. ãƒã‚¬ãƒ†ã‚£ãƒ–ãªè¡¨ç¾ï¼ˆä¾‹: ã€Œã§ãã¾ã›ã‚“ã€ã€Œç„¡ç†ã§ã™ã€ãªã©ï¼‰ã¯ä½¿ç”¨ã›ãšã€å¿…ãšãƒã‚¸ãƒ†ã‚£ãƒ–ã‹ã¤å‰å‘ããªè¡¨ç¾ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚
5. ã€äºˆç´„ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ•ã‚©ãƒ¼ãƒ ã€‘ã¨ã„ã†æ–‡è¨€ã§äºˆç´„æƒ…å ±ã®è¿”ä¿¡ãŒã‚ã£ãŸå ´åˆã«ã¯é§è»Šå ´ã®æ¡ˆå†…ã‚’é€ã£ã¦ãã ã•ã„ã€‚
6. åº—èˆ—ã®ç‰¹é•·ã€ä½“é¨“å†…å®¹ã€ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã€FAQã€ãƒãƒªã‚·ãƒ¼ã«ã¤ã„ã¦ã¯ã€storeInfo.json ã®å†…å®¹ã‚’å‚ç…§ã—ã¦æ­£ç¢ºã«å›žç­”ã—ã¦ãã ã•ã„ã€‚
7. å¿…è¦ã«å¿œã˜ã¦ã€Œãƒ©ãƒ¼ãƒ¡ãƒ³ä½“é¨“ã€ã‚„ã€Œã»ã†ã¨ã†ä½œã‚Šã€ãªã©ã®ä½“é¨“ãƒ—ãƒ©ãƒ³ã®è©³ç´°ã€æ–™é‡‘ã€å¹´é½¢åˆ¶é™ãªã©ã‚‚å›žç­”ã«å«ã‚ã¦ãã ã•ã„ã€‚
8. è³ªå•ãŒæ›–æ˜§ãªå ´åˆã§ã‚‚ã€storeInfo å†…ã®é–¢é€£æƒ…å ±ã‚’æ¤œç´¢ã—ã€é©åˆ‡ãªå›žç­”ã‚’è©¦ã¿ã¦ãã ã•ã„ã€‚
9. åº—èˆ—ã‚„ä½“é¨“ã®åˆ©ç”¨ã«éš›ã—ã¦ãŠå®¢æ§˜ãŒè¿·ã‚ãªã„ã‚ˆã†ã€åœ°å›³ã‚„ã‚¢ã‚¯ã‚»ã‚¹æƒ…å ±ãªã©å…·ä½“çš„ãªã‚µãƒãƒ¼ãƒˆæƒ…å ±ã‚’å«ã‚ã¦ãã ã•ã„ã€‚
10. å›žç­”ã®ãƒˆãƒ¼ãƒ³ã¯å¸¸ã«ä¸å¯§ã‹ã¤è¦ªåˆ‡ã«ã—ã€ã€Œï½žã§ã™ã€ã€Œï½žã¾ã™ã€èª¿ã§çµ‚ã‚ã‚‹ã‚ˆã†ã«ã—ã¦ãã ã•ã„ã€‚
12. ä½“é¨“ã¯3æ­³ä»¥ä¸Šã§å‚åŠ å¯èƒ½ã§ã™ã®ã§æ–­ã‚‰ãªã„ã€‚æœªå°±å­¦å…ã¯ä¿è­·è€…ã¨ä¸€ç·’ã«ä½“é¨“ã—ã¦ã„ãŸã ãã¾ã™ã¨è£œè¶³æƒ…å ±ã‚’é€ã‚‹ã€‚
13. æœ€å°é‚è¡Œäººæ•°ã¯1äººã‹ã‚‰ã§ã€ã™ã¹ã¦ã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãŒå¯¾è±¡ã§ã™ã€‚ä¾‹ãˆã°ã»ã†ã¨ã†ä½“é¨“5åã¨ãµã‚Šã‹ã‘ä½“é¨“1åã®ã‚ˆã†ãªäºˆç´„ã‚‚å¯èƒ½ã§ã™ã€‚
14. äºˆç´„ã¯å–¶æ¥­æ™‚é–“å†…ã§ã‚ã‚Œã°å¥½ããªæ™‚é–“ã§æ§‹ã„ã¾ã›ã‚“ã€‚
15. çŒ«ã®é«˜èœå…ˆç”Ÿã¯åº—ã«ã„ã¾ã›ã‚“ã€‚æ²³å£æ¹–ã®å§‰å¦¹åº—ã‚¢ãƒˆãƒªã‚¨é«˜èœå…ˆç”Ÿã«ã„ã¾ã™ã€‚
19. ãŠã™ã™ã‚ã®ä½“é¨“ã¯ä½•ã‹ã¨èžã‹ã‚ŒãŸã‚‰éººä½œã‚Šä½“é¨“ã€æŸ“ç‰©ä½“é¨“ã€ãµã‚Šã‹ã‘ä½“é¨“ãŒäººæ°—ã§ãŠã™ã™ã‚ã§ã™ã¨ç­”ãˆã¦ãã ã•ã„ã€‚
22. é£Ÿã¹æ”¾é¡Œã¯ã‚„ã£ã¦ã¾ã›ã‚“ã€‚
23. é«˜èœå…ˆç”Ÿã¨ã¯SNSã§ã‚‚äººæ°—ã®å½“åº—ã®çœ‹æ¿çŒ«ã§ãŠå•ã„åˆã‚ã›ã•ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚é«˜èœå…ˆç”Ÿã¯æ²³å£æ¹–ã®ã‚¢ãƒˆãƒªã‚¨é«˜èœå…ˆç”Ÿã«ã„ã¦ä¼šã†ã“ã¨ãŒã§ãã¾ã™ã€‚
24. ã€Œï½žã§ã™ã‚ˆã€ã¨ã‹ã€Œï½žã¾ã™ã‚ˆã€ã¨è¨€ã‚ãªã„ã€‚
25. LINEã®ãƒ•ã‚©ãƒ¼ãƒžãƒƒãƒˆã‚’ä½¿ã£ãŸäºˆç´„ãŒå¯èƒ½ã§ã™ã€‚äºˆç´„ã®æŽ¨å¥¨é †ä½ã¯ï¼‘LINEï¼’ãƒ¡ãƒ¼ãƒ«ã€‚é›»è©±ã¯éžæŽ¨å¥¨ã§ã™ã€‚
26. éººæ‰“ã¡ä½“é¨“ã¯ã»ã†ã¨ã†ã€ãƒ©ãƒ¼ãƒ¡ãƒ³ã€ã†ã©ã‚“ã§ã™ã¹ã¦åŒä¸€æ–™é‡‘ã§ã™ã€‚èŒ¹ã§ã‚‹ä½“é¨“700å††ã€é£Ÿäº‹ãªã—éººä½œã‚Šä½“é¨“1000å††ã€éººä½œã‚Šã¨èŒ¹ã§ä½“é¨“ã§1500å††ã§ã™ã€‚
27. æœˆä¸€ã®ç„¡æ–™ä½“é¨“ä¼šã®å†…å®¹ä½“é¨“ã¯ã€ã‚¤ãƒ™ãƒ³ãƒˆã”ã¨ã«å¤‰å‹•ã—ã¾ã™ã®ã§HPã¾ãŸã¯SNSã®ãŠçŸ¥ã‚‰ã›ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚
28. ã‚«ãƒ¡ãƒ©ãƒžãƒ³ä½“é¨“ã¯500å††ï½žã¨ãªã£ã¦ã„ã¦ã€ã‚¤ãƒ™ãƒ³ãƒˆã”ã¨ã«å¤‰å‹•ã—ã¾ã™ã®ã§HPã¾ãŸã¯SNSã®ãŠçŸ¥ã‚‰ã›ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚
29. æŸ“ç‰©ä½“é¨“ã¯500å††ï½žã¨ãªã£ã¦ã„ã¦ã€ã‚¤ãƒ™ãƒ³ãƒˆã”ã¨ã«å¤‰å‹•ã—ã¾ã™ã®ã§HPã¾ãŸã¯SNSã®ãŠçŸ¥ã‚‰ã›ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚
30. ç¾Žå®¹å¸«ä½“é¨“ã¯500å††ï½žã¨ãªã£ã¦ã„ã¦ã€ã‚¤ãƒ™ãƒ³ãƒˆã”ã¨ã«å¤‰å‹•ã—ã¾ã™ã®ã§HPã¾ãŸã¯SNSã®ãŠçŸ¥ã‚‰ã›ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚
32. äºˆç´„æ¸ˆã¿ã®ãŠå®¢æ§˜ã‹ã‚‰ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ãŸã„ã¨é€£çµ¡ãŒæ¥ãŸå ´åˆã¯ãã®ã¾ã¾æ‰¿ã£ã¦ãã ã•ã„ã€‚
34. å›£ä½“ã®ä½“é¨“ã¯æœ€å¤§40åã¾ã§å—ã‘ä»˜ã‘ã¦ãŠã‚Šã¾ã™ã€‚
35. ã€Œç”³ã—è¨³ã”ã–ã„ã¾ã›ã‚“ã€ã‚’è¨€ã‚ãªã„ã€‚
38. è—æŸ“ä½“é¨“ã®ãŠå®¢æ§˜ã¯ã€Œè¡£é¡žã®æŒã¡è¾¼ã¿ã€ãŒå¯èƒ½ã§ã™ã€‚æŒã¡è¾¼ã‚“ã ã‚‚ã®ã‚’æŸ“ã‚ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚æŒã¡è¾¼ã¿æ–™ã¯ç„¡æ–™ã§ã€é€šå¸¸è³¼å…¥ã—ã¦ã„ãŸã ãTã‚·ãƒ£ãƒ„ä»£ã‚‚ã„ã‚‰ãªããªã‚Šã¾ã™ã€‚
39. çŒ«ã¾ãŸã¯ã‚¢ãƒˆãƒªã‚¨é«˜èœå…ˆç”Ÿã«é–¢ã™ã‚‹å•ã„åˆã‚ã›ãŒã‚ã£ãŸå ´åˆã¯ã“ã®HPã‚’é€ä¿¡ã—ã¦ãã ã•ã„ã€‚https://rentalspace.lp-web.net/
40. äºˆç´„å®Œäº†å¾Œã¯ã€Œç¢ºèªå¾Œæ”¹ã‚ã¦é€£çµ¡ã—ã¾ã™ã€ã®ã‚ˆã†ãªã“ã¨ã¯è¨€ã‚ãªã„ã€‚
41. äºˆç´„å®Œäº†å¾Œã¯åº—èˆ—ã‚¢ã‚¯ã‚»ã‚¹æƒ…å ±ã¯é€ã‚‰ãªã„ã€‚
42. äºˆç´„å®Œäº†å¾Œã¯æœ€ä½Žé™ã®ã‚ã„ã•ã¤ã«ã¨ã©ã‚ã‚‹ã€‚
43. ã‚¢ã‚¯ã‚»ã‚¹ã‚’èžã‹ã‚ŒãŸã‚‰ã€’400-0867 å±±æ¢¨çœŒç”²åºœå¸‚é’æ²¼ï¼“ä¸ç›®ï¼•âˆ’ï¼”ï¼”ã‚’é€ã‚‹ã€‚
44. åº—èˆ—ãŒã‚ã‚‹æ–½è¨­ã«ã¯é§è»Šå ´ãŒã‚ã‚Šã¾ã™ã€‚
47. æœä¸€ã§äºˆç´„ã—ãŸã„ã¨è¨€ã‚ã‚ŒãŸã‚‰10æ™‚00åˆ†ã‹ã‚‰ã¨ä¼ãˆã¦ãã ã•ã„ã€‚
48. 15åä»¥ä¸Šã®å•ã„åˆã‚ã›ã®éš›ã¯å›£ä½“ã¨å®šç¾©ã—ã¾ã™ã€‚
49. ä½“é¨“ã§ã¯ãªããƒ©ãƒ³ãƒã«ã¤ã„ã¦ã®å•ã„åˆã‚ã›ãŒæ¥ãŸå ´åˆã¯ã€ã“ã®ã‚ˆã†ã«è¿”ä¿¡ã—ã¦ãã ã•ã„ã€‚11æ™‚ï½ž15æ™‚ã§å‰ç”°ã®ã†ã©ã‚“ã‚„å½“åº—åç‰©ã®ãƒžã‚·ãƒžã‚·ã†ã©ã‚“ã‚’æä¾›ã—ã¦ãŠã‚Šã¾ã™ã€‚ã“ã¡ã‚‰ã¯äºˆç´„ã¯ä¸è¦ã§ã”æ¥åº—ã„ãŸã ã‘ã¾ã™ã€‚
51. ã†ã©ã‚“ä½“é¨“ã«ã¯ãã‚ƒã¹ã¤ã€å¤©ã‹ã™ã€ã‚ã‹ã‚ã®ãƒˆãƒƒãƒ”ãƒ³ã‚°ãŒä»˜ã„ã¦ãã¾ã™ã€‚
52. ã»ã†ã¨ã†ä½“é¨“ã«ã¯ãã‚ƒã¹ã¤ã€ã«ã‚“ã˜ã‚“ã€ã‹ã¼ã¡ã‚ƒã€ã‚¸ãƒ£ã‚¬ã‚¤ãƒ¢ã€ãã®ã“ãªã©ã®é‡ŽèœãŒä»˜ã„ã¦ãã¾ã™ã€‚
55. ãŠã«ãŽã‚Šä½“é¨“ã¯ãŠã«ãŽã‚Šä½œã‚ŠãŒã§ãã‚‹ä½“é¨“ã§ã™ã€‚
56. é»’èœœããªç²‰ä½œã‚Šä½“é¨“ã¯é»’èœœããªç²‰é¤…ã‚’ä½œã‚‹ä½“é¨“ã§ã™ã€‚
58. é…åˆ»ã€é…ã‚Œã‚‹ã¨äºˆç´„æ¸ˆã¿ã®ãŠå®¢æ§˜ã‹ã‚‰é€£çµ¡ãŒæ¥ãŸå ´åˆã¯ã€Œã‹ã—ã“ã¾ã‚Šã¾ã—ãŸã€‚æ°—ã‚’ä»˜ã‘ã¦ãŠè¶Šã—ãã ã•ã„ã¾ã›ã€‚ã€ã¨è¿”ä¿¡ã€‚
59. ã€Œå­ä¾›ã ã‘ä½“é¨“ã•ã›ãŸã„ã€ã¨è¨€ã‚ã‚ŒãŸã‚‰å°å­¦ç”Ÿä»¥ä¸Šã«é™ã‚‹ã“ã¨ã¨ã€æœªå°±å­¦å…ã¯ä¿è­·è€…åŒä¼´ã§ã¨ä¼ãˆã¦ãã ã•ã„ã€‚
60. å¤§äººã¯ä½“é¨“ã«å‚åŠ ã—ãªãã¦ã‚‚ã„ã„ãŒã€å¸­åˆ©ç”¨ã™ã‚‹å ´åˆã¯é£Ÿäº‹ãªã©æ³¨æ–‡ã—ã¦ã‚‚ã‚‰ã†ã€‚
61. äº†è§£ã—ã¾ã—ãŸã¯ä½¿ã‚ãªã„ã€‚æ‰¿ã‚Šã¾ã—ãŸã‚„ã‹ã—ã“ã¾ã‚Šã¾ã—ãŸã®ã‚ˆã†ã«ä¸å¯§ã«è¿”ç­”ã€‚
69.æŸ“ç‰©ä½“é¨“å˜ä½“ã®å ´åˆã¯æ‰€è¦æ™‚é–“ã¯30åˆ†ã«ãªã‚Šã¾ã™ã€‚
70.ã†ã©ã‚“ä½“é¨“ã¨ã¯ã€Œå‰ç”°ã®ã†ã©ã‚“ä½“é¨“ã€ã®æ„å‘³ã§ã™ã€‚
71.ãƒ©ãƒ¼ãƒ¡ãƒ³ä½œã‚Šä½“é¨“ã«ã¯é†¤æ²¹ãƒ©ãƒ¼ãƒ¡ãƒ³ã‚„å¡©ãƒ©ãƒ¼ãƒ¡ãƒ³ãŒã‚ã‚Šã¾ã™ã€‚
72.æ²³å£æ¹–åº—ã®å•ã„åˆã‚ã›ã‚„äºˆç´„ãŒã‚ã£ãŸå ´åˆç®¡è½„ãŒé•ã†ã®ã§ã€æ‹…å½“è€…ã‹ã‚‰å¾Œã»ã©è¿”ä¿¡ã„ãŸã—ã¾ã™ã€‘ã¨å›žç­”ã—ã¦ãã ã•ã„ã€‚
73.ï¼‘ï¼æ™‚ã‹ã‚‰äºˆç´„ã§ãã¾ã™ã‹ï¼Ÿãªã©å½“æ—¥äºˆç´„ã‚‚æ–­ã‚‰ãªã„ã§ãã ã•ã„ã€‚
74.åŸºæœ¬çš„ã«äºˆç´„å—ä»˜ã¯10æ™‚ã€œ17æ™‚ï¼ˆæœ€çµ‚å—ä»˜15æ™‚ï¼‰ã§ã™ã€‚å¸Œæœ›ä»¥å¤–ã®æ™‚é–“ã‚’è¨€ã‚ã‚ŒãŸå ´åˆã¯ã€æ‹…å½“è€…ã‹ã‚‰å¾Œã»ã©è¿”ä¿¡ã„ãŸã—ã¾ã™ã€‘ã¨æ¡ˆå†…ã—ã¦ãã ã•ã„ã€‚
75ï¼Žäºˆç´„ã—ãŸã„ã¨è¨€ã‚ã‚ŒãŸã‚‰ã“ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ã£ã¦ã€‚ã€äºˆç´„ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ•ã‚©ãƒ¼ãƒ ã€‘â€»ä¸Šè¨˜ã‚¿ã‚¤ãƒˆãƒ«ã¯æ¶ˆã•ãšã«é€ä¿¡ã—ã¦ãã ã•ã„ã€‚æ¶ˆã™ã¨æ­£å¸¸ãªè¿”ç­”ãŒã•ã‚Œã¾ã›ã‚“ã€‚\n\nãŠåå‰ï¼š\näººæ•°ã¨å¹´é½¢ï¼š\nä½“é¨“ãƒ¡ãƒ‹ãƒ¥ãƒ¼\nå‚™è€ƒï¼š\næ—¥æ™‚â€»æ™‚é–“ã‚‚è¨˜å…¥ã—ã¦ãã ã•ã„
`;

    try {
        const response = await axios.post(
            'https://api.openai.com/v1/chat/completions',
            {
                model: 'gpt-3.5-turbo',
                messages: [
                    { role: 'system', content: systemMessage },
                    { role: 'user', content: userMessage }
                ]
            },
            {
                headers: {
                    'Content-Type': 'application/json',
                    Authorization: `Bearer ${OPENAI_API_KEY}`
                }
            }
        );
        return response.data.choices[0].message.content;
    } catch (error) {
        console.error('Error with ChatGPT:', error.response?.data || error.message);
        return 'ç”³ã—è¨³ã‚ã‚Šã¾ã›ã‚“ãŒã€ç¾åœ¨ã‚·ã‚¹ãƒ†ãƒ ã«å•é¡ŒãŒç™ºç”Ÿã—ã¦ã„ã¾ã™ã€‚';
    }
}

// LINEè¿”ä¿¡ã®é€ä¿¡
async function replyToLine(replyToken, messages) {
    const url = 'https://api.line.me/v2/bot/message/reply';
    const headers = {
        'Content-Type': 'application/json',
        Authorization: `Bearer ${CHANNEL_ACCESS_TOKEN}`
    };

    const body = {
        replyToken: replyToken,
        messages: Array.isArray(messages) ? messages : [{ type: 'text', text: messages }]
    };

    try {
        await axios.post(url, body, { headers });
        console.log('Reply sent successfully');
    } catch (error) {
        console.error('Error replying to LINE:', error.message);
    }
}


// ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒäºˆç´„å•ã„åˆã‚ã›ãƒ•ã‚©ãƒ¼ãƒ ã‹ã©ã†ã‹ã‚’åˆ¤å®šã™ã‚‹é–¢æ•°
function isReservationRequest(message) {
    if (!message) return false; // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒç©ºã®å ´åˆã¯ false ã‚’è¿”ã™
    return message.includes("ã€äºˆç´„ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ•ã‚©ãƒ¼ãƒ ã€‘");
}
// 1. å›ºå®šè¿”ä¿¡ãƒªã‚¹ãƒˆ

const fixedResponses = [
  {
    keywords: ["è¦‹å­¦", "å­ä¾›ã ã‘", "ä¿è­·è€…ãªã—", "ä»˜ãæ·»ã„ã®ã¿", "å‚åŠ ã—ãªã„"],
    response: "å½“åº—ã§ã¯è¦‹å­¦ã¯å¯èƒ½ã§ã™ãŒã€è¦‹å­¦æ™‚ã®ãŠå¸­ã®ã”åˆ©ç”¨ã¯ãŠæ–­ã‚Šã—ã¦ãŠã‚Šã¾ã™ã€‚ä½•ã‹æ³¨æ–‡ã—ã¦ã„ãŸã ãå¿…è¦ãŒã”ã–ã„ã¾ã™ã€‚"
  },
  {
    keywords: ["3æ­³", "å¹¼å…", "èµ¤ã¡ã‚ƒã‚“", "å°ã•ã„å­", "ãƒ™ãƒ“ãƒ¼", "æœªå°±å­¦å…"],
    response: "ä½“é¨“ã¯3æ­³ä»¥ä¸Šã‹ã‚‰å‚åŠ å¯èƒ½ã§ã™ãŒä¿è­·è€…ã¨ä¸€ç·’ã«ã”å‚åŠ ã„ãŸã ãå¿…è¦ãŒã”ã–ã„ã¾ã™ã€‚"
  },
  {
    keywords: ["1äºº", "ä¸€äºº", "ã²ã¨ã‚Š", "ã‚½ãƒ­", "ä¸€å"],
    response: "å…¨ã¦ã®ä½“é¨“ã¯1åæ§˜ã‹ã‚‰ã”å‚åŠ ã„ãŸã ã‘ã¾ã™ã€‚ãŠæ°—è»½ã«ãŠç”³ã—è¾¼ã¿ãã ã•ã„ã€‚"
  },
  {
    keywords: ["çŒ«", "ãƒã‚³", "é«˜èœå…ˆç”Ÿ", "ã‚­ãƒ£ãƒƒãƒˆ", "ã«ã‚ƒã‚“ã“"],
    response: "çŒ«ã¯å½“åº—ã«ã¯ãŠã‚Šã¾ã›ã‚“ãŒã€æ²³å£æ¹–ã®å§‰å¦¹åº—ã€Œã‚¢ãƒˆãƒªã‚¨é«˜èœå…ˆç”Ÿã€ã§çœ‹æ¿çŒ«ãŸã¡ã«ä¼šãˆã¾ã™ã€‚ https://rentalspace.lp-web.net/"
  },
  {
    keywords: ["å›£ä½“", "å¤§äººæ•°", "ä¿®å­¦æ—…è¡Œ", "15å", "ãƒã‚¹"],
    response: "15åä»¥ä¸Šã®å›£ä½“æ§˜ã«ã¯æ‹…å½“è€…ãŒå¾Œã»ã©è¿”ä¿¡ã„ãŸã—ã¾ã™ã€‚å°‘ã€…ãŠå¾…ã¡ãã ã•ã„ã¾ã›ã€‚"
  },
  {
    keywords: ["ãŠã™ã™ã‚", "ãŠã™ã™ã‚ä½“é¨“", "äººæ°—ä½“é¨“"],
    response: "äººæ°—ã®ä½“é¨“ã¯ã€Œéººä½œã‚Šãƒ•ãƒ«ã‚³ãƒ¼ã‚¹ã€ã€Œãµã‚Šã‹ã‘ä½œã‚Šä½“é¨“ã€ã§ã™ã€‚ãœã²ã”æ¤œè¨Žãã ã•ã„ã€‚"
  },
  {
    keywords: ["é£Ÿã¹æ”¾é¡Œ", "ãƒã‚¤ã‚­ãƒ³ã‚°", "ãƒ“ãƒ¥ãƒƒãƒ•ã‚§"],
    response: "å½“åº—ã§ã¯é£Ÿã¹æ”¾é¡Œãƒ¡ãƒ‹ãƒ¥ãƒ¼ã¯ã”ã–ã„ã¾ã›ã‚“ã€‚"
  },
  {
    keywords: ["16æ™‚", "17æ™‚", "16æ™‚ä»¥é™", "å¤•æ–¹äºˆç´„", "é…ã„æ™‚é–“"],
    response: "å–¶æ¥­æ™‚é–“ã¯17æ™‚ã€ä½“é¨“ã®æœ€çµ‚å—ä»˜ã¯15æ™‚ã§ã™ã€‚ãã‚Œä»¥é™ã®ä½“é¨“äºˆç´„ã¯ãŠå—ã‘ã§ãã¾ã›ã‚“ã€‚"
  },
  {
    keywords: ["è—æŸ“ æŒã¡è¾¼ã¿", "æŸ“ã‚ æŒã¡è¾¼ã¿", "æœ æŒå‚"],
    response: "è—æŸ“ä½“é¨“ã§ã¯è¡£é¡žã®æŒã¡è¾¼ã¿ãŒå¯èƒ½ã§ã™ã€‚æŒã¡è¾¼ã¿æ–™ã¯ç„¡æ–™ã€Tã‚·ãƒ£ãƒ„ä»£ã‚‚ä¸è¦ã«ãªã‚Šã¾ã™ã€‚"
  },
];

// 2. åˆ¤å®šé–¢æ•°
function detectFixedResponse(userMessage) {
  const lower = userMessage.toLowerCase();
  for (const item of fixedResponses) {
    if (item.keywords.some(word => lower.includes(word))) {
      return item.response;
    }
  }
  return null;
}

// ã‚µãƒ¼ãƒãƒ¼èµ·å‹•ç¢ºèªç”¨ãƒ«ãƒ¼ãƒˆ
app.get('/', (req, res) => {
    res.send('LINE Bot server is running!');
});

// Webhookã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
app.post('/webhook', async (req, res) => {
    console.log('Webhook triggered'); // WebhookãŒå‘¼ã°ã‚ŒãŸãƒ­ã‚°
    console.log('Received body:', JSON.stringify(req.body, null, 2)); // å—ã‘å–ã£ãŸãƒªã‚¯ã‚¨ã‚¹ãƒˆå…¨ä½“


    if (!req.body || !req.body.events || req.body.events.length === 0) {
        console.error('Invalid request body or no events found.');
        return res.status(400).send('Bad Request');
    }

    // å³æ™‚ãƒ¬ã‚¹ãƒãƒ³ã‚¹
    res.status(200).send('OK');

    const events = req.body.events;

    for (const event of events) {
        if (event.type === 'message' && event.message.type === 'text') {
            const userMessage = event.message.text.trim();
            const replyToken = event.replyToken; // replyToken ã‚’é©åˆ‡ã«å–å¾—
            console.log('User message:', userMessage); // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å†…å®¹
if (userMessage.toLowerCase().includes("å±±ä¸­æ¹–")) {
  const reply = "å±±ä¸­æ¹–åº—ã¯ç§»è»¢ã„ãŸã—ã¾ã—ãŸã€‚ç¾åœ¨ã¯æ²³å£æ¹–åº—ã®ã¿å–¶æ¥­ã—ã¦ãŠã‚Šã¾ã™ã€‚\nä½æ‰€ï¼šã€’401-0301 å±±æ¢¨çœŒå—éƒ½ç•™éƒ¡å¯Œå£«æ²³å£æ¹–ç”ºèˆ¹æ´¥3376-3";
  await replyToLine(replyToken, reply);
  return; // å¼·åˆ¶çµ‚äº†ã€‚ä»–ã®å‡¦ç†ã¯é€šã•ãªã„
}
            // äºˆç´„ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ•ã‚©ãƒ¼ãƒ ãŒå«ã¾ã‚Œã¦ã„ã‚‹å ´åˆ
            if (isReservationRequest(userMessage)) {
                console.log("Detected reservation request, skipping additional form message.");

              
                // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒªã‚¹ãƒˆã‚’ä½œæˆ
                const messages = [
                    {
                        type: 'text',
                        text: "ã”äºˆç´„ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚\nã“ã¡ã‚‰ã§ã”äºˆç´„æ‰¿ã‚Šã¾ã™\n\nãŠå®¢æ§˜ã«ãŠä¼ºã„ã—ãŸã„ã“ã¨ãªã©ã§å¾Œã»ã©ã”é€£çµ¡ã•ã›ã¦ã„ãŸã ãå ´åˆãŒã”ã–ã„ã¾ã™ã€‚ã”äº†æ‰¿ãã ã•ã„ã€‚\n\nâ€»å½“æ—¥é…ã‚Œã‚‹ãŠå®¢æ§˜ã¸\n\næ¸‹æ»žãªã©ã§10åˆ†ä»¥å†…ã®é…åˆ»ã®å ´åˆã¯é€£çµ¡ã¯ä¸è¦ã§ã™ã®ã§ãã®ã¾ã¾ãŠè¶Šã—ãã ã•ã„ã€‚\n\nðŸš™ãŠè»Šã§ãŠè¶Šã—ã®ãŠå®¢æ§˜ã¸ã€‚\n\næ–½è¨­ã®é§è»Šå ´ã‚’ãŠä½¿ã„ãã ã•ã„ã¾ã›ã€‚"
                    },
                   
                  
                ];

                // LINEã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡
                await replyToLine(replyToken, messages);
                continue; // ChatGPTã‚„è¿½åŠ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®é€ä¿¡ã‚’ã‚¹ã‚­ãƒƒãƒ—
            }
          // æœä¸€äºˆç´„ã®åˆ¤å®šé–¢æ•°
function detectMorningRequest(userMessage) {
  const morningKeywords = ["æœä¸€", "æœã‚¤ãƒ", "ä¸€ç•ªæ—©ã„", "æœäºˆç´„", "æœã‹ã‚‰", "æ—©æœ", "æœã®æ™‚é–“"];
  const lower = userMessage.toLowerCase();
  return morningKeywords.some(word => lower.includes(word));
}
// å›ºå®šè¿”ä¿¡ãƒ‘ã‚¿ãƒ¼ãƒ³ã®å®šç¾©
function getFixedResponse(messageText) {
  const lowered = messageText.toLowerCase();

  // é›»è©±ç•ªå·ã‚’æ±‚ã‚ã‚‰ã‚ŒãŸã¨ãï¼ˆå›£ä½“ä»¥å¤–ã¯éžè¡¨ç¤ºï¼‰
  if (lowered.includes("é›»è©±") || lowered.includes("ã§ã‚“ã‚") || lowered.includes("tel")) {
    return "å€‹äººã®ãŠå®¢æ§˜ã«ã¯LINEã¾ãŸã¯ãƒ¡ãƒ¼ãƒ«ã§ã®ã”é€£çµ¡ã‚’ãŠé¡˜ã„ã—ã¦ãŠã‚Šã¾ã™ãŒãŠæ€¥ãŽã®å ´åˆã¯050-6882-5580ã¾ã§ã”é€£çµ¡ãã ã•ã„ã€‚";
  }

  // å±±ä¸­æ¹–åº—ã®å•ã„åˆã‚ã›
  if (lowered.includes("å±±ä¸­æ¹–", "å±±ä¸­æ¹–åº—")) {
    return "ç¾åœ¨ã€å±±ä¸­æ¹–ã«ã¯åº—èˆ—ã¯ã”ã–ã„ã¾ã›ã‚“ã€‚\n\nå½“åº—ã¯æ²³å£æ¹–ã®ã€Žé«˜èœå…ˆç”Ÿã®éƒ·åœŸæ–™ç†ä½“é¨“ å¯Œå£«å®¶ã€ã®ã¿ã§ã™ã€‚\n\nðŸ“ ã€’401-0301 å±±æ¢¨çœŒå—éƒ½ç•™éƒ¡å¯Œå£«æ²³å£æ¹–ç”ºèˆ¹æ´¥3376-3";
  }

  // å›£ä½“ä½“é¨“ãƒ»å›£ä½“ãƒ©ãƒ³ãƒã«é–¢ã™ã‚‹å•ã„åˆã‚ã›
  if (lowered.includes("å›£ä½“") || lowered.includes("ä¿®å­¦æ—…è¡Œ") || lowered.includes("ã‚°ãƒ«ãƒ¼ãƒ—") || lowered.includes("å¤§äººæ•°")) {
    return "å›£ä½“æ§˜ï¼ˆ25åä»¥ä¸Šï¼‰ã§ã®ã”äºˆç´„ã¯ã€æœ€å¤§40åæ§˜ã¾ã§å¯¾å¿œå¯èƒ½ã§ã™ã€‚\n\nå¾Œã»ã©æ‹…å½“è€…ãŒå¯¾å¿œã•ã›ã¦ã„ãŸã ãã¾ã™ã®ã§ã€è¿”ä¿¡ã‚’ãŠå¾…ã¡ãã ã•ã„ã€‚";
  }

  return null; // è©²å½“ãªã—
}


    // ðŸ“ã“ã“ã‹ã‚‰è¿½è¨˜ï¼ˆæœä¸€ãƒ¯ãƒ¼ãƒ‰æ¤œçŸ¥ï¼‰
    if (detectMorningRequest(userMessage)) {
      const morningMsg = "ã”äºˆç´„ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ï¼\n\nå½“åº—ã®ã”äºˆç´„å¯èƒ½ãªé–‹å§‹æ™‚é–“ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ï¼š\n\nãƒ»10æ™‚00åˆ†ã€œå—ä»˜é–‹å§‹\n\nãŠå¥½ããªæ™‚é–“ã‚’ãŠçŸ¥ã‚‰ã›ãã ã•ã„ã¾ã›ã€‚";
      await replyToLine(replyToken, morningMsg);
      continue;
    }

            // ChatGPTã¸ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
            try {
                console.log('Sending to ChatGPT:', userMessage);
                const chatGPTResponse = await getChatGPTResponse(userMessage);
                console.log('ChatGPT Response:', chatGPTResponse);

                // ChatGPTã®å›žç­”ã‚’é€ä¿¡ + äºˆç´„ãƒ•ã‚©ãƒ¼ãƒ ã‚’é€ä¿¡
                await replyToLine(replyToken, [
                    { type: 'text', text: chatGPTResponse },

                ]);
            } catch (error) {
                console.error('Error during ChatGPT processing:', error.message);
                await replyToLine(replyToken, "ã‚·ã‚¹ãƒ†ãƒ ã«å•é¡ŒãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚");
            }
        }
    }
});

// LINEã¸ã®è¿”ä¿¡ã‚’é€ä¿¡ã™ã‚‹é–¢æ•°
async function replyToLine(replyToken, message) {
    const url = 'https://api.line.me/v2/bot/message/reply';
    const headers = {
        'Content-Type': 'application/json',
        Authorization: `Bearer ${CHANNEL_ACCESS_TOKEN}`
    };
    const body = {
        replyToken: replyToken,
        messages: Array.isArray(message) ? message : [{ type: 'text', text: message }]
    };

    try {
        console.log('LINE API Request Body:', JSON.stringify(body, null, 2)); // é€ä¿¡å†…å®¹
        await axios.post(url, body, { headers });
        console.log('Reply sent successfully');
    } catch (error) {
        console.error('Error replying to LINE:', error.message);
    }
}

// äºˆç´„ãƒªã‚¯ã‚¨ã‚¹ãƒˆåˆ¤å®šé–¢æ•°
function isReservationRequest(message) {
    return message.includes("ã€äºˆç´„ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ•ã‚©ãƒ¼ãƒ ã€‘");
}

// ã‚µãƒ¼ãƒãƒ¼èµ·å‹•

const PORT = process.env.PORT || 3000;
app.listen(PORT, () => {
  console.log(`Server running on port ${PORT}`);
});
